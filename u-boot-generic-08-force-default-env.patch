From b3c4220f1cc6d9f775a417459b5cbe51bb1202ae Mon Sep 17 00:00:00 2001
From: Ondrej Kubik <ondrej.kubik@canonical.com>
Date: Fri, 17 Nov 2017 12:58:31 +0000
Subject: [PATCH 1/1] Forcing default environment with controlled writable
 overlay

Signed-off-by: Ondrej Kubik <ondrej.kubik@canonical.com>
---
 common/env_common.c               | 9 +++++++--
 include/configs/dragonboard410c.h | 1 +
 scripts/config_whitelist.txt      | 1 +
 3 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/common/env_common.c b/common/env_common.c
index 6845f8d..4655ede 100644
--- a/common/env_common.c
+++ b/common/env_common.c
@@ -194,6 +194,10 @@ int env_import(const char *buf, int check)
 	env_t *ep = (env_t *)buf;
 	int ret;
 
+	char * const vars[] = {CONFIG_ENV_WHITELIST};
+	const int nvars = sizeof(vars) / sizeof(char *);
+	// first import default variables
+	set_default_env("Importing default environment\n");
 	if (check) {
 		uint32_t crc;
 
@@ -213,8 +217,9 @@ int env_import(const char *buf, int check)
 		return ret;
 	}
 
-	if (himport_r(&env_htab, (char *)ep->data, ENV_SIZE, '\0', 0, 0,
-			0, NULL)) {
+	puts("Overlaying environment\n");
+	if (himport_r(&env_htab, (char *)ep->data, ENV_SIZE, '\0', H_NOCLEAR | H_INTERACTIVE, 0,
+			nvars, vars)) {
 		gd->flags |= GD_FLG_ENV_READY;
 		return 1;
 	}
diff --git a/include/configs/dragonboard410c.h b/include/configs/dragonboard410c.h
index 5e5b533..6dedcf7 100644
--- a/include/configs/dragonboard410c.h
+++ b/include/configs/dragonboard410c.h
@@ -116,6 +116,7 @@ REFLASH(dragonboard/u-boot.img, 8)\
 	"pxefile_addr_r=0x90100000\0"\
 	BOOTENV
 
+#define CONFIG_ENV_WHITELIST  "snap_mode","snap_core","snap_try_core","snap_kernel","snap_try_kernel", "load_device", NULL
 #undef CONFIG_ENV_IS_NOWHERE
 #define CONFIG_ENV_SIZE		SZ_128K
 #define CONFIG_ENV_IS_IN_FAT
diff --git a/scripts/config_whitelist.txt b/scripts/config_whitelist.txt
index ed349b9..efdba80 100644
--- a/scripts/config_whitelist.txt
+++ b/scripts/config_whitelist.txt
@@ -842,6 +842,7 @@ CONFIG_ENV_UBI_VOLUME_REDUND
 CONFIG_ENV_VARS_UBOOT_CONFIG
 CONFIG_ENV_VARS_UBOOT_RUNTIME_CONFIG
 CONFIG_ENV_VERSION
+CONFIG_ENV_WHITELIST
 CONFIG_ENV_xxx
 CONFIG_EP9301
 CONFIG_EP9302
-- 
2.7.4

